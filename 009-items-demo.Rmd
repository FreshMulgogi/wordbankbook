# Individual Words: Demographics^[An earlier version of the gender analyses below was presented to the Boston University Conference on Language Development in 2016] {#words-demographics}


In Chapter \@ref(demographics), we documented demographic differences in total vocabulary. In this chapter, we consider the possibility that individual words carry this demographic signal. Which words are learned differentially earlier or later by girls vs. boys, by first-born vs. later-born children, and by children with different levels of maternal education?

```{r 9_params}
sample_cutoff <- 50
num_extremes <- 3
```

```{r 9_raw_data, eval=FALSE}
get_inst_data <- function(inst_items) {

  inst_language <- unique(inst_items$language)
  print(inst_language)

  inst_form <- unique(inst_items$form)
  inst_admins <- filter(admins, language == inst_language, form == inst_form)

  get_instrument_data(language = inst_language,
                      form = inst_form,
                      items = inst_items$item_id,
                      administrations = inst_admins,
                      iteminfo = inst_items) %>%
    filter(!is.na(age)) %>%
    mutate(produces = !is.na(value) & value == "produces",
           understands = !is.na(value) &
             (value == "understands" | value == "produces")) %>%
    select(-value) %>%
    gather(measure, value, produces, understands) %>%
    mutate(language = inst_language,
           form = inst_form)
}

get_lang_data <- function(lang_items) {
  lang_items %>%
    split(.$form) %>%
    map_df(get_inst_data) %>%
    ## production for WS & WG, comprehension for WG only
    filter(measure == "produces" | form == "WG")
}

demo_insts <- admins %>%
  filter(!is.na(birth_order) | !is.na(mom_ed) | !is.na(sex)) %>%
  distinct(language, form)

demo_words <- items %>%
  right_join(demo_insts) %>%
  filter(type == "word")

raw_data <- demo_words %>%
  split(.$language) %>%
  map(get_lang_data)

write_feather(bind_rows(raw_data), "data/items-demo/demo_data.feather")
```

```{r 9_raw_data_coded, eval=FALSE}
raw_data <- read_feather("data/items-demo/demo_data.feather") %>%
  split(.$language)

raw_data_coded <- raw_data %>%
  map(~.x %>%
        mutate(birth_order = birth_order %>%
                 fct_collapse("Third+" = c("Third", "Fourth", "Fifth", "Sixth",
                                           "Seventh", "Eighth")),
               mom_ed = mom_ed %>%
                 fct_collapse(`Below Secondary` = c("None","Primary",
                                                    "Some Secondary"),
                              `Secondary` = c("Secondary", "Some College"),
                              `College and Above` = c("College",
                                                      "Some Graduate",
                                                      "Graduate"))))

samples <- raw_data_coded %>%
  map_df(~.x %>%
           distinct(language, measure, age, sex, birth_order, mom_ed, data_id) %>%
           select(-data_id) %>%
           gather(demo, value, sex, birth_order, mom_ed) %>%
           count(language, measure, demo, value) %>%
           filter(!is.na(value)))
```

```{r 9_plot_samples, eval=FALSE}
plot_samples <- function(plot_measure, plot_demo) {
  ggplot(filter(samples, measure == plot_measure, demo == plot_demo),
         aes(x = value, y = log(n), fill = value)) +
    facet_wrap(~language) +
    geom_col() +
    geom_hline(yintercept = log(sample_cutoff), linetype = "dashed",
               colour = "darkgrey") +
    scale_fill_solarized() +
    ggtitle(paste(plot_measure, plot_demo, sep = " "))
}
plot_samples("produces", "birth_order")
plot_samples("produces", "mom_ed")
plot_samples("produces", "sex")
plot_samples("understands", "birth_order")
plot_samples("understands", "mom_ed")
plot_samples("understands", "sex")
```

```{r 9_get_demo_props, eval=FALSE}
get_demo_props <- function(lang_data_coded, demo) {

  demo_str <- as.character(demo)[2]
  message(unique(lang_data_coded$language), " - ", demo_str)

  if (lang_data_coded %>% pull(!!demo) %>% is.na() %>% all()) return(NULL)

  demo_lang_data <- lang_data_coded %>%
    filter(!is.na(!!demo))

  demo_samples <- demo_lang_data %>%
    distinct(!!demo, data_id, measure) %>%
    count(!!demo, measure)

  if (any(demo_samples$n < sample_cutoff)) return(NULL)

  demo_lang_data %>%
    ungroup() %>%
    group_by(language, measure, !!demo, age, uni_lemma, definition) %>%
    summarise(n = n(),
              num_true = sum(value, na.rm = TRUE),
              num_false = n - num_true) %>%
    ungroup() %>%
    mutate(unscaled_age = age,
           age = scale(age),
           demo = demo_str) %>%
    group_by(language, measure, demo) %>%
    nest()
}

demos <- c(quo(birth_order), quo(mom_ed), quo(sex))

get_lang_props <- function(lang_data) {
  demos %>% map_df(~get_demo_props(lang_data, .x))
}

demo_props <- raw_data_coded %>%
  map_df(get_lang_props)

save(demo_props, file = "data/items-demo/demo_props.Rds")
#write_feather(unnest(demo_props), "data/items-demo/demo_props.feather")
```

## Data

Various subsets of the datasets in Wordbank are coded for one or more demographic variables: the child's birth order, maternal level of education, and assigned sex at birth. For these analyses we pull out all of the instruments with demographically coded data and combine them into per language measures: comprehension from WG forms and production from both WG and WS forms. This gives datasets for six different analyses, one for each combination of demographic variable and measure. We exclude a language from a given analysis if it has fewer than `r sample_cutoff` children for that demographic variable and measure. The demographic variables are coded into the values First / Second / Third+ for birth order, Below Secondary / Secondary / College and Above for maternal education, and Female / Male for sex.

```{r 9_plot_props}
#demo_props <- read_feather("data/items-demo/demo_props.feather")
load("data/items-demo/demo_props.Rds")

demo_labels <- list("sex" = "Sex",
                    "birth_order" = "Birth order",
                    "mom_ed" = "Maternal education")

plot_demo_props <- demo_props %>%
  unnest() %>%
  mutate(prop = num_true / (num_true + num_false)) %>%
  split(.$demo)

plot_props <- function(plot_demo, plot_measure, ncol = NULL) {
  plot_demo_props[[plot_demo]] %>% filter(measure == plot_measure) %>%
    ggplot(aes_string(x = "unscaled_age", y = "prop", colour = plot_demo)) +
      facet_wrap(~language, ncol = ncol) +
      geom_smooth(method = "glm", method.args = list(family = "binomial"),
                  se = FALSE, size = 0.8) +
      scale_colour_solarized() +
      labs(x = "Age (months)", y = glue("Proportion {plot_measure}"),
           colour = demo_labels[[plot_demo]]) +
      lims(y = c(0, 1)) +
      theme(legend.position = "top")
}

plot_item_props <- function(plot_demo, plot_measure, plot_items, ncol = NULL) {
  plot_demo_props[[plot_demo]] %>%
    filter(measure == plot_measure, definition %in% plot_items) %>%
    ggplot(aes_string(x = "unscaled_age", y = "prop", colour = plot_demo)) +
      facet_wrap(~definition, ncol = ncol) +
      geom_smooth(method = "glm", method.args = list(family = "binomial"),
                  se = FALSE, size = 0.8) +
      scale_colour_solarized() +
      labs(x = "Age (months)", y = glue("Proportion {plot_measure}"),
           colour = demo_labels[[plot_demo]]) +
      lims(y = c(0, 1)) +
      theme(legend.position = "top")
}
```

Each dataset then gives a trajectory of how many children are reported to understand/produce each word over age, separately for each value of the demographic variable. For example, for production data by birth order, these are the trajectories for some sample items in English:

```{r 9_props_plot_item, dependson="9_plot_props", fig.height=3}
plot_item_props("birth_order", "produces", c("brother", "dog", "green"), 4)
```

And here are the trajectories across all items in each language:

```{r 9_props_plot, dependson="9_plot_props"}
plot_props("birth_order", "produces", 4)
# plot_props("mom_ed", "produces")
# plot_props("sex", "produces", 4)
# plot_props("birth_order", "understands", 4)
# plot_props("mom_ed", "understands")
# plot_props("sex", "understands", 4)
```

The goal of the analyses is to quantify the overall effect of each demographic variable, i.e. the differences among the above curves, and the individual contribution of each item to that effect.

```{r 9_fit_models, eval=FALSE}
contr_back_diff <- function(k) {
  column <- function(i) c(rep(-(k - i) / k, i), rep(i / k, k - i))
  map(1:(k - 1), column) %>% as.data.frame() %>% as.matrix() %>% unname()
}

fit_demo_model <- function(language, measure, demo, demo_data) {
  message(language, " - ", measure, " - ", demo)
  
  if (length(levels(demo_data[[demo]])) < 2) return(NULL)
  demo_contrasts <- contr_back_diff(length(levels(demo_data[[demo]])))
  contrasts(demo_data[[demo]]) <- demo_contrasts
  
  group_formula <- as.formula(glue(
    "cbind(num_true, num_false) ~
      (age + {demo} | definition) + {demo} + age"
  ))
  
  safe_model <- possibly(function() {
    model <- glmer(group_formula, family = binomial, data = demo_data)
    save(model, file = glue("data/items-demo/models/{language}_{measure}_{demo}.Rds"))
    return(model)
  }, otherwise = NULL)
  safe_model()

}

cores <- parallel::detectCores()
cluster <- multidplyr::create_cluster(cores = cores)

demo_groups <- demo_props %>%
  mutate(group = rep(1:cores, length.out = n())) %>%
  multidplyr::partition(group, cluster = cluster)

demo_groups %>%
  multidplyr::cluster_library("tidyverse") %>%
  multidplyr::cluster_library("glue") %>%
  multidplyr::cluster_library("lme4") %>%
  multidplyr::cluster_assign_value("fit_demo_model", fit_demo_model) %>%
  multidplyr::cluster_assign_value("contr_back_diff", contr_back_diff)

demo_model_setup <- demo_groups %>%
  mutate(model = pmap(list(language, measure, demo, data), fit_demo_model))

demo_models <- demo_model_setup %>%
  collect() %>%
  as_tibble()
```

```{r 9_demo_fits, eval=FALSE}
get_coef <- function(model) {
  model %>% tidy() %>% filter(group == "fixed") %>% select(-group)
}

get_ranef <- function(model) {
  ranef(model)$definition %>% as_tibble(rownames = "definition")
}

demo_fits <- demo_models %>%
  ungroup() %>%
  filter(!map_lgl(model, is.null)) %>%
  mutate(coefs = map(model, get_coef),
         ranef = map(model, get_ranef))

demo_coefs <- demo_fits %>%
  select(language, measure, demo, coefs) %>%
  unnest()

demo_ranef <- demo_fits %>%
  select(language, measure, demo, ranef) %>%
  unnest()

write_feather(demo_coefs, "data/items-demo/demo_coefs.feather")
write_feather(demo_ranef, "data/items-demo/demo_ranef.feather")
```

## Models

We use a mixed-effects logistic regression to predict how many children produce/understand items from their age and their level for a given demographic variable, with a random effect for item. This model is fit separately for the data for each language and measure. For example, the model for birth order would be specified as:
```
cbind(num_true, num_false) ~ (age + birth_order | definition) + age + birth_order
```
The contrasts for each demographic variable are set up such that their coefficient compares each level of the variable to the previous level. So the coefficents for birth order, for example, reflect the overall difference between second born as compared to first born and the overall difference between third and later born as compared to second born. The items' random slopes for each demographic indicate for each individual item, the contribution to those same differences over the main effect.

## Results

### Language-wide effects

The following are the main effects for each demographic variable and measure.

```{r 9_plot_coefs}
demo_coefs <- read_feather("data/items-demo/demo_coefs.feather")

demo_levels <- function(demo) {
  demo_props %>% filter(demo == demo) %>% slice(1) %>% pull(data) %>% .[[1]] %>%
    pull(!!demo) %>% levels()
}

demo_coefs_coded <- demo_coefs %>%
  filter(!(term %in% c("(Intercept)", "age"))) %>%
  mutate(ci_lower = estimate - 1.96 * std.error,
         ci_upper = estimate + 1.96 * std.error,
         ## TODO: do factor recoding automatically
         term = term %>% fct_recode("Male – Female" = "sexMale",
                                    "Secondary – Below Secondary" = "mom_ed1",
                                    "College and Above – Secondary" = "mom_ed2",
                                    "Second – First" = "birth_order1",
                                    "Third+ – Second" = "birth_order2",
                                    NULL = "mom_edCollege and Above")) %>%
  filter(!is.na(term))

plot_demo_coefs <- function(plot_demo) {
  plot_data <- demo_coefs_coded %>%
    filter(demo == plot_demo) %>%
    arrange(term, estimate) %>%
    mutate(language = fct_inorder(language))
  ggplot(plot_data, aes(x = language, y = estimate, colour = term)) +
    facet_wrap(~measure) +
    coord_flip() +
    geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper),
                    position = position_dodge(width = 0.25), fatten = 3) +
    scale_colour_solarized() +
    labs(y = "Coefficient estimate", x = "", colour = demo_labels[[plot_demo]]) +
    theme(legend.position = "top")
}
```

```{r 9_coefs_plot_bo, dependson="9_plot_coefs", fig.height=4}
plot_demo_coefs("birth_order")
```
```{r 9_coefs_plots_me, dependson="9_plot_coefs", fig.height=4}
plot_demo_coefs("mom_ed")
```
```{r 9_coefs_plots_sex, dependson="9_plot_coefs", fig.height=6, fig.width=8}
plot_demo_coefs("sex")
```

### Item-specific effects

The following are the distributions of the item random effects for each demographic variables and measure, with the top and bottom `r num_extremes` items labelled.

```{r 9_plot_ranef}
demo_ranef <- read_feather("data/items-demo/demo_ranef.feather")

demo_ranef_coded <- demo_ranef %>%
  gather(term, estimate, -language, -measure, -demo, -definition) %>%
  filter(!is.na(estimate)) %>%
  filter(!(term %in% c("(Intercept)", "age"))) %>%
  mutate(## TODO: do factor recoding automatically
         term = term %>% fct_recode("Male – Female" = "sexMale",
                                    "Secondary – Below Secondary" = "mom_ed1",
                                    "College and Above – Secondary" = "mom_ed2",
                                    "Second – First" = "birth_order1",
                                    "Third+ – Second" = "birth_order2",
                                    NULL = "mom_edCollege and Above")) %>%
  filter(!is.na(term))

plot_demo_ranef <- function(plot_demo, plot_measure) {

  demo_data <- demo_ranef_coded %>%
    filter(demo == plot_demo, measure == plot_measure)

  demo_labelled <- bind_rows(
    demo_data %>% group_by(language, term) %>% top_n(num_extremes, estimate),
    demo_data %>% group_by(language, term) %>% top_n(num_extremes, -estimate)
  )

  ggplot(demo_data, aes(x = estimate, fill = term)) +
    facet_wrap(~language + term, ncol = 4) +
    geom_density() +
    geom_label_repel(aes(label = definition, y = 0),
                     data = demo_labelled,
                     segment.size = 0.3,
                     label.padding = 0.15,
                     point.padding = unit(0.2, "lines"),
                     arrow = arrow(length = unit(0.01, "npc")),
                     nudge_y = 5,
                     family = font, size = 2.5, fill = "white") +
    scale_fill_solarized(guide = FALSE) +
    labs(x = "Coefficient estimate", y = "Number of words",
         title = glue("{demo_labels[[plot_demo]]} ({plot_measure})"))
}
```

```{r 9_ranef_plot_bo_prod, dependson="9_plot_ranef", fig.height=9}
plot_demo_ranef("birth_order", "produces")
```
```{r 9_ranef_plot_me_prod, dependson="9_plot_ranef", fig.height=7}
plot_demo_ranef("mom_ed", "produces")
```
```{r 9_ranef_plot_sex_prod, dependson="9_plot_ranef", fig.height=16}
plot_demo_ranef("sex", "produces")
```
```{r 9_ranef_plot_bo_comp, dependson="9_plot_ranef", fig.height=5}
plot_demo_ranef("birth_order", "understands")
```
```{r 9_ranef_plots_me_comp, dependson="9_plot_ranef", fig.height=5}
plot_demo_ranef("mom_ed", "understands")
```
```{r 9_ranef_plots_sex_comp, dependson="9_plot_ranef", fig.height=11}
plot_demo_ranef("sex", "understands")
```
